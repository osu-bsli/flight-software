# Coding Guidelines

## General

### Keep your program code separate from `main.c`.

Don't write your program logic directly in `main.c`, which is autogenerated by STM32CubeMX. Instead, create a separate file called `program.c` for your application code. In `main.c`, after the generated initialization code, insert a call to your program logic.

```h
// program.h
#pragma once
void program(void);
```

```c
// program.c
void program(void) {
    while (true) {
        // Your program logic goes here.
    }
}
```

```c
// main.c 

// ...

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "program.h"
/* USER CODE END Includes */

// ...

int main(void) {
    /*
     * CubeMX generated initialization code.
     */

    HAL_Init(); 
    SystemClock_Config(); 
    MX_GPIO_Init(); 
    MX_SPI1_Init(); 

    // ...

    /* USER CODE BEGIN 2 */

    /* Function call to your program code.
     * Place it after the generated initialization code but before the
     * generated infinite loop.
     * It must be placed between USER CODE BEGIN and USER CODE END comments
     * so CubeMX doesn't erase it the next time you press "Generate Code."
     */
    program();

    /* USER CODE END 2 */

    /*
     * CubeMX generated infinite loop.
     */
    while (1) {

    }
}    

```

## Sensor Drivers

### Do not use magic numbers. Use `#define` for constants, including register addresses and bit masks.

```c
/*
 * Bad: Magic number is used directly.  
 */

if (who_am_i_read_val != 0b00110011) {
    return HAL_ERROR;
} 

/*
 * Good: Constant is defined and used.
 */

// Define constants at the start of the .c file
#define WHO_AM_I_EXPECTED 0b00110011

// ...

// Use defined constant in code
if (who_am_i_read_val != WHO_AM_I_EXPECTED) {
    return HAL_ERROR;
}
```

### `#define` shared constants in `.h` files so other `.c` files can include them. `#define` private constants directly in `.c` files.

```c
// Only the driver code in lis3dh.c needs to see these defines, place them in lis3dh.c
#define CTRL_REG1 0x20
#define CTRL_REG1_ODR_10HZ 0b00100000   // 10 Hz
#define CTRL_REG1_ODR_100HZ 0b01010000  // 100 Hz
#define CTRL_REG1_ODR_1344HZ 0b10010000 // 1344 Hz
#define CTRL_REG1_ENABLE_ALL_AXES 0b111

// These constants could be useful to other .c files, place them in lis3dh.h
// Prefix shared constants properly (with LIS3DH in this case) so it is clear which module they came from.
#define LIS3DH_AXIS_MAX_RAW 32767 
#define LIS3DH_AXIS_MIN_RAW -32768
#define LIS3DH_AXIS_MAX_G 8.0 
#define LIS3DH_AXIS_MIN_G -8.0
```

### Return a status value from any function that can fail. 

```c
HAL_StatusTypeDef lis3dh_initialize(void) {
    if (!callback) {
        // No callback is registered.

        /*
         * Return early with HAL_ERROR if something went wrong.
         */

        return HAL_ERROR;
    }
    
    // ...

    /*
     * Return HAL_OK if we made it to the end of the function.
     */

    return HAL_OK;
}
```

### Check all return values of functions that can fail. **Improperly handled sensor failures could result in serious consequences, such as failure to deploy parachute and loss of vehicle.**

```c
HAL_StatusTypeDef spi_write(const uint8_t *data, const uint16_t data_len) {
    HAL_StatusTypeDef status

    /*
     * Bad: HAL_SPI_Transmit's return value is ignored. 
     */ 

    HAL_SPI_Transmit(HSPI, data, data_len, TIMEOUT);
    
    /*
     * Good: The return value of HAL_SPI_Transmit is checked and returned if not HAL_OK.
     */

    status = HAL_SPI_Transmit(HSPI, data, data_len, TIMEOUT);
    // Return early if a function we call fails.
    if (status != HAL_OK) return status;

    /*
     * Return HAL_OK if we made it to the end of the function.
     */
     
    return HAL_OK;
}
```

### If a function will only be called from the C file it is defined in, declare it `static` so that it is inaccessible to other C files.

```c
/*
 * This function is inside the lis3dh.c sensor driver file.
 * It is for reading registers from the LIS3DH accelerometer and is not part of
 * the public interface for that driver so it is declared static. 
 */
static HAL_StatusTypeDef read(const uint8_t addr, uint8_t *data,
                              const uint16_t data_len) {

    // ...

}
```